# عرض الطلبات والدفع في تطبيق Flutter — Mirmaia Worker

هذا الملف يشرح **كيف تُعرَض الطلبات** في التطبيق، و**كيف يتم الدفع** (إنشاء طلب فقط، أو طلب + دفع فوراً).

---

## ١. عرض الطلبات

### أين تُعرَض؟

- شاشة **الطلبات** (`OrdersScreen`) — من التنقل السفلي أو من الرئيسية ← الطلبات.

### كيف تعمل؟

1. **مصدر البيانات:** الطلبات تُقرأ من Firebase بشكل مباشر (Real-time).
2. **المسار:**  
   `restaurant-system/orders/mirmaia-1`
3. **الاستدعاء:**  
   `FirebaseService.getOrdersStream()` يرجع **Stream** على كل الطلبات، فالتطبيق يحدّث القائمة تلقائياً عند أي تغيير.

### ما الذي يظهر في القائمة؟

- **رقم الطلب** (آخر 6 أحرف من الـ id).
- **الحالة:** قيد الانتظار / قيد التحضير / جاهز / مكتمل / ملغي.
- **طاولة أو غرفة** (إن وُجدت): من `tableNumber` أو `roomNumber`.
- **عدد العناصر** و**الإجمالي** (ر.ع).

### تفاصيل الطلب (عند الضغط على البطاقة)

- نفس الحالة.
- قائمة **العناصر:** اسم × كمية — السعر.
- **الإجمالي.**
- أزرار **بدء التحضير** / **جاهز** (حسب الحالة) لتحديث الحالة.

### تحديث الحالة

- من نافذة التفاصيل:
  - **معلّق** → زر **بدء التحضير** → تصبح **قيد التحضير**.
  - **قيد التحضير** → زر **جاهز** → تصبح **جاهز**.
- التحديث يُسجَّل في Firebase عبر `FirebaseService.updateOrder(orderId, {'status': newStatus})`.

### ملاحظات تقنية

- الترتيب: من **الأحدث إلى الأقدم** حسب `timestamp` أو `createdAt`.
- العرض يستخدم `tableNumber` و `roomNumber` من الطلب (لا `tableName` / `roomName`).

---

## ٢. الدفع وإنشاء الطلبات من الكاشير

### أين يتم؟

- شاشة **الكاشير** (`CashierScreen`).

### ماذا يمكنك أن تفعل؟

1. **إنشاء طلب فقط (بدون دفع الآن)**  
   - تضيف منتجات للسلة → تضغط **إنشاء طلب**.  
   - يُنشأ طلب بحالة `pending` في Firebase.  
   - يظهر لاحقاً في **الطلبات** ويمكن تغيير حالته (بدء التحضير → جاهز).

2. **إنشاء طلب + دفع فوراً (Pay Now)**  
   - تضيف منتجات للسلة → تضغط **دفع الآن** (إن وُجد في الواجهة).  
   - الطلب يُنشأ مع `status: 'paid'` و `paymentStatus: 'paid'`.  
   - حالياً التطبيق يمرّر هذه القيم في `createOrder` فقط (لا يوجد `payAndCloseOrder` منفصل مثل الويب).

### كيف يُنشأ الطلب؟

- الاستدعاء: `FirebaseService.createOrder(orderData)`.
- `orderData` يشمل مثلاً:
  - `items`: عناصر الطلب (منتج، variation، كمية، سعر، إجمالي).
  - `total`, `subtotal`, `discount`.
  - `orderType`: `'takeaway'` | `'table'` | `'room'`.
  - `tableId` / `tableNumber` إن كان طلب طاولة.
  - `roomId` / `roomNumber` إن كان طلب غرفة.
  - `status`, `paymentStatus`, `source: 'cashier'`, `restaurantId: 'mirmaia-1'`.

### مسار البيانات

```
المستخدم يضيف منتجات للسلة
    ↓
يختار نوع الطلب: تيك أواي / طاولة / غرفة (إن وُجدت الواجهة)
    ↓
إنشاء طلب فقط → createOrder → orders في Firebase (pending)
    أو
إنشاء طلب + دفع → createOrder مع status paid → نفس المسار
```

---

## ٣. الخلاصة السريعة

| المطلوب | أين | ماذا يحدث |
|--------|-----|-----------|
| **عرض الطلبات** | شاشة الطلبات | `getOrdersStream()` من Firebase، قائمة مباشرة وتحديث لحظي |
| **تفاصيل طلب** | الضغط على بطاقة طلب | نافذة تفاصيل + عناصر + إجمالي |
| **تحديث الحالة** | من نافذة التفاصيل | `updateOrder(orderId, {'status': ...})` |
| **إنشاء طلب (كاشير)** | شاشة الكاشير | إضافة للسلة → إنشاء طلب → `createOrder` |
| **دفع فوراً (كاشير)** | شاشة الكاشير (إن وُجد) | إنشاء طلب مع `status: 'paid'` |

---

## ٤. الملفات ذات الصلة

| الوظيفة | الملف |
|---------|-------|
| عرض الطلبات وتحديث الحالة | `lib/screens/orders_screen.dart` |
| الكاشير وإنشاء الطلب / الدفع | `lib/screens/cashier_screen.dart` |
| Firebase: الطلبات والتحديث | `lib/services/firebase_service.dart` (`getOrdersStream`, `createOrder`, `updateOrder`) |

---

## ٥. لو احتجت "دفع طلب معلّق" لاحقاً

- في **تطبيق الويب** يوجد: طلبات اليوم المعلقة → اختيار طلب → دفع → `payAndCloseOrder` (فاتورة، تحديث الطلب، تحرير الطاولة/الغرفة).
- في **تطبيق Flutter** حالياً: لا توجد شاشة "طلبات معلّقة" مع زر دفع مخصّص. يمكن إضافتها لاحقاً بعرض الطلبات `pending` من نفس المسار ثم استدعاء منطق دفع (مثلاً تحديث الطلب + إنشاء فاتورة إن رغبت).

إذا أردت، يمكن توضيح خطوات إضافة "دفع طلب معلّق" في Flutter خطوة بخطوة في ملف منفصل.
