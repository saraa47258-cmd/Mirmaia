<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirmaia | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar"></aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <h2>ğŸ’¨ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Mirmaia</h2>
                <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Ø¨Ø­Ø«..." id="search-input">
                </div>
                <div class="user-info" style="display: flex; align-items: center; gap: 15px; margin-left: 15px;">
                    <div style="text-align: right;">
                        <div style="font-weight: 600; font-size: 14px;" id="user-name-display">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="user-role-display">Ø£Ø¯Ù…Ù†</div>
                    </div>
                    <button class="btn btn-secondary" onclick="clearAppCache()" style="background: rgba(167, 139, 250, 0.1); color: #A78BFA; border: 1px solid rgba(167, 139, 250, 0.2); padding: 10px 18px;" title="ØªØ­Ø¯ÙŠØ« ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´">
                        <i class="fas fa-sync-alt"></i>
                        ØªØ­Ø¯ÙŠØ«
                    </button>
                    <button class="btn btn-danger" onclick="logout()" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 10px 18px;">
                        <i class="fas fa-sign-out-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card coffee">
                <div class="stat-icon">
                    <i class="fas fa-cloud"></i>
                </div>
                <div class="stat-value" id="stat-products">0</div>
                <div class="stat-label">Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø´ÙŠØ´Ø©</div>
                <div class="stat-change up">
                    <i class="fas fa-arrow-up"></i>
                    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
            
            <div class="stat-card orders">
                <div class="stat-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="stat-value" id="stat-orders">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                <div class="stat-change up">
                    <i class="fas fa-arrow-up"></i>
                    <span id="orders-change">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
            
            <div class="stat-card revenue">
                <div class="stat-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-value" id="stat-revenue">0</div>
                <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø±.Ø¹)</div>
                <div class="stat-change up">
                    <i class="fas fa-arrow-up"></i>
                    <span id="revenue-change">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
            
            <div class="stat-card customers">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-value" id="stat-items-sold">0</div>
                <div class="stat-label">Ø£ØµÙ†Ø§Ù Ù…Ø¨Ø§Ø¹Ø©</div>
                <div class="stat-change up">
                    <i class="fas fa-arrow-up"></i>
                    <span id="items-change">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="section-header" style="margin-bottom: 20px;">
            <h3 style="font-size: 1.3rem; font-weight: 700;">
                <i class="fas fa-bolt" style="color: var(--gold);"></i>
                Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
            </h3>
            <button class="btn btn-primary" onclick="initializeSampleData()" id="init-sample-data-btn" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-database"></i>
                ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            </button>
        </div>
        
        <div class="cards-grid" style="margin-bottom: 30px;">
            <a href="menu.html" class="card" style="text-decoration: none; color: inherit;">
                <div class="card-image" style="background: linear-gradient(135deg, #A78BFA, #F59E0B);">
                    â˜•
                </div>
                <div class="card-body">
                    <h4 class="card-title">Ø§Ù„Ù…Ù†ÙŠÙˆ</h4>
                    <p class="card-text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª ÙˆØ§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª</p>
                </div>
            </a>
            
            <a href="barcode.html" class="card" style="text-decoration: none; color: inherit;">
                <div class="card-image" style="background: linear-gradient(135deg, #10b981, #059669);">
                    ğŸ“±
                </div>
                <div class="card-body">
                    <h4 class="card-title">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h4>
                    <p class="card-text">Ù…Ø³Ø­ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</p>
                </div>
            </a>
            
            <a href="cashier.html" class="card" style="text-decoration: none; color: inherit;">
                <div class="card-image" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    ğŸ’°
                </div>
                <div class="card-body">
                    <h4 class="card-title">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</h4>
                    <p class="card-text">Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</p>
                </div>
            </a>
            
            <a href="inventory.html" class="card" style="text-decoration: none; color: inherit;">
                <div class="card-image" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    ğŸ“¦
                </div>
                <div class="card-body">
                    <h4 class="card-title">Ø§Ù„Ù…Ø®Ø²Ù†</h4>
                    <p class="card-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…ÙˆØ§Ø¯</p>
                </div>
            </a>
            
            <a href="rooms.html" class="card" style="text-decoration: none; color: inherit;">
                <div class="card-image" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                    ğŸ›‹ï¸
                </div>
                <div class="card-body">
                    <h4 class="card-title">Ø§Ù„ØºØ±Ù Ø§Ù„Ø®Ø§ØµØ©</h4>
                    <p class="card-text">Ø­Ø¬Ø² Ø§Ù„ØºØ±Ù ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª VIP</p>
                </div>
            </a>
        </div>
        
        <!-- Recent Orders -->
        <div class="section-header" style="margin-bottom: 20px;">
            <h3 style="font-size: 1.3rem; font-weight: 700;">
                <i class="fas fa-clock" style="color: var(--primary);"></i>
                Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </h3>
        </div>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙˆÙ‚Øª</th>
                    </tr>
                </thead>
                <tbody id="recent-orders">
                    <tr>
                        <td>#1001</td>
                        <td>Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</td>
                        <td>2x Ù„Ø§ØªÙŠÙ‡ØŒ 1x ÙƒØ±ÙˆØ§Ø³ÙˆÙ†</td>
                        <td>48 Ø±.Ø¹</td>
                        <td><span class="badge badge-success">Ù…ÙƒØªÙ…Ù„</span></td>
                        <td>Ù…Ù†Ø° 5 Ø¯Ù‚Ø§Ø¦Ù‚</td>
                    </tr>
                    <tr>
                        <td>#1002</td>
                        <td>Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ</td>
                        <td>1x ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ</td>
                        <td>20 Ø±.Ø¹</td>
                        <td><span class="badge badge-warning">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span></td>
                        <td>Ù…Ù†Ø° 10 Ø¯Ù‚Ø§Ø¦Ù‚</td>
                    </tr>
                    <tr>
                        <td>#1003</td>
                        <td>Ø®Ø§Ù„Ø¯ Ù…Ø­Ù…Ø¯</td>
                        <td>3x Ù‚Ù‡ÙˆØ© Ø¹Ø±Ø¨ÙŠØ©ØŒ 2x ÙƒÙŠÙƒ</td>
                        <td>81 Ø±.Ø¹</td>
                        <td><span class="badge badge-success">Ù…ÙƒØªÙ…Ù„</span></td>
                        <td>Ù…Ù†Ø° 15 Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    </tr>
                    <tr>
                        <td>#1004</td>
                        <td>Ù†ÙˆØ±Ø© Ø³Ø¹ÙŠØ¯</td>
                        <td>1x ÙØ±Ø§Ø¨ØªØ´ÙŠÙ†ÙˆØŒ 1x Ù…ÙˆÙƒØ§</td>
                        <td>47 Ø±.Ø¹</td>
                        <td><span class="badge badge-primary">Ø¬Ø¯ÙŠØ¯</span></td>
                        <td>Ù…Ù†Ø° Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/common.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/auth-check.js"></script>
    <script src="js/init-sample-data.js"></script>
    
    <script src="js/sidebar.js?v=1.1"></script>
    <script src="js/app.js"></script>
    <script>
        // ==========================================
        // Real Statistics from Firebase
        // ==========================================
        const RESTAURANT_ID = 'mirmaia-1';
        
        const MENU_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/menu`;
        const ORDERS_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/orders`;
        const SALES_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/sales`;
        
        let menuItems = [];
        let orders = [];
        let yesterdayStats = {
            orders: 0,
            revenue: 0,
            customers: 0
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initFirebaseListeners();
        });

        // Real-time Firebase listeners
        function initFirebaseListeners() {
            // Listen to orders in real-time
            firebase.database().ref(ORDERS_PATH).orderByChild('createdAt').limitToLast(20).on('value', (snapshot) => {
                const ordersData = snapshot.val() || {};
                orders = Object.keys(ordersData)
                    .map(key => ({ id: key, ...ordersData[key] }))
                    .filter(order => order.status !== 'cancelled') // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºÙŠØ©
                    .sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt).getTime() : (a.timestamp || 0);
                        const dateB = b.createdAt ? new Date(b.createdAt).getTime() : (b.timestamp || 0);
                        return dateB - dateA;
                    });
                loadRecentOrders();
                loadRealStatistics();
            });

            // Listen to menu items
            firebase.database().ref(MENU_PATH).on('value', (snapshot) => {
                const menuData = snapshot.val() || {};
                menuItems = Object.keys(menuData)
                    .map(key => ({ id: key, ...menuData[key] }))
                    .filter(item => item.active !== false);
                loadRealStatistics();
            });

            // Listen to today's sales
            const today = new Date().toISOString().split('T')[0];
            firebase.database().ref(`${SALES_PATH}/${today}`).on('value', (snapshot) => {
                const salesData = snapshot.val();
                if (salesData) {
                    updateSalesDisplay(salesData);
                }
            });
        }

        function updateSalesDisplay(salesData) {
            document.getElementById('stat-orders').textContent = salesData.ordersCount || 0;
            document.getElementById('stat-revenue').textContent = (salesData.totalRevenue || 0).toFixed(3);
            document.getElementById('stat-items-sold').textContent = salesData.itemsSold || 0;
            
            // Update change texts
            const ordersChange = document.getElementById('orders-change');
            const revenueChange = document.getElementById('revenue-change');
            const itemsChange = document.getElementById('items-change');
            
            if (ordersChange) ordersChange.textContent = `${salesData.ordersCount || 0} Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„`;
            if (revenueChange) {
                const cash = salesData.cashPayments || 0;
                const card = salesData.cardPayments || 0;
                revenueChange.textContent = `Ù†Ù‚Ø¯ÙŠ: ${cash.toFixed(2)} | Ø¨Ø·Ø§Ù‚Ø©: ${card.toFixed(2)}`;
            }
            if (itemsChange) itemsChange.textContent = `${salesData.itemsSold || 0} ØµÙ†Ù ØªÙ… Ø¨ÙŠØ¹Ù‡`;
        }
        
        // Load real statistics
        async function loadRealStatistics() {
            try {
                // Load menu items
                const menuSnapshot = await firebase.database().ref(MENU_PATH).once('value');
                const menuData = menuSnapshot.val() || {};
                menuItems = Object.keys(menuData)
                    .map(key => ({ id: key, ...menuData[key] }))
                    .filter(item => item.active !== false);
                
                // Load orders
                const ordersSnapshot = await firebase.database().ref(ORDERS_PATH).once('value');
                const ordersData = ordersSnapshot.val() || {};
                orders = Object.keys(ordersData)
                    .map(key => ({ id: key, ...ordersData[key] }))
                    .filter(order => order.status !== 'cancelled') // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºÙŠØ©
                    .sort((a, b) => (b.createdAt || b.timestamp || 0) - (a.createdAt || a.timestamp || 0));
                
                // Calculate today's date (start of day)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                
                // Calculate yesterday's date (start of day)
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayTimestamp = yesterday.getTime();
                
                // End of today
                const endOfToday = todayTimestamp + (24 * 60 * 60 * 1000);
                
                // Filter today's orders
                const todayOrders = orders.filter(order => {
                    let orderDate = order.createdAt || order.timestamp || 0;
                    // Handle ISO string dates
                    if (typeof orderDate === 'string') {
                        orderDate = new Date(orderDate).getTime();
                    }
                    return orderDate >= todayTimestamp && orderDate < endOfToday;
                });
                
                // Filter yesterday's orders
                const yesterdayOrders = orders.filter(order => {
                    let orderDate = order.createdAt || order.timestamp || 0;
                    // Handle ISO string dates
                    if (typeof orderDate === 'string') {
                        orderDate = new Date(orderDate).getTime();
                    }
                    return orderDate >= yesterdayTimestamp && orderDate < todayTimestamp;
                });
                
                // Calculate statistics
                const totalProducts = menuItems.length;
                
                const todayOrdersCount = todayOrders.length;
                const yesterdayOrdersCount = yesterdayOrders.length;
                const ordersChange = yesterdayOrdersCount > 0 ? 
                    ((todayOrdersCount - yesterdayOrdersCount) / yesterdayOrdersCount * 100).toFixed(0) : 0;
                
                // Calculate revenue (from completed/paid orders)
                const todayRevenue = todayOrders
                    .filter(o => o.status === 'completed' || o.status === 'paid' || o.status === 'delivered')
                    .reduce((sum, o) => sum + parseFloat(o.total || o.amount || 0), 0);
                
                const yesterdayRevenue = yesterdayOrders
                    .filter(o => o.status === 'completed' || o.status === 'paid' || o.status === 'delivered')
                    .reduce((sum, o) => sum + parseFloat(o.total || o.amount || 0), 0);
                
                const revenueChange = yesterdayRevenue > 0 ? 
                    ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(0) : 0;
                
                // Calculate unique customers today
                const todayCustomers = new Set();
                todayOrders.forEach(order => {
                    if (order.customerName) todayCustomers.add(order.customerName);
                    if (order.customerPhone) todayCustomers.add(order.customerPhone);
                    if (order.tableNumber) todayCustomers.add(`table-${order.tableNumber}`);
                });
                
                const yesterdayCustomers = new Set();
                yesterdayOrders.forEach(order => {
                    if (order.customerName) yesterdayCustomers.add(order.customerName);
                    if (order.customerPhone) yesterdayCustomers.add(order.customerPhone);
                    if (order.tableNumber) yesterdayCustomers.add(`table-${order.tableNumber}`);
                });
                
                const todayCustomersCount = todayCustomers.size;
                const yesterdayCustomersCount = yesterdayCustomers.size;
                const newCustomers = todayCustomersCount - yesterdayCustomersCount;
                
                // Calculate products added this week
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                weekAgo.setHours(0, 0, 0, 0);
                const weekAgoTimestamp = weekAgo.getTime();
                
                const newProductsThisWeek = menuItems.filter(item => {
                    let itemDate = item.createdAt || item.timestamp || 0;
                    // Handle ISO string dates
                    if (typeof itemDate === 'string') {
                        itemDate = new Date(itemDate).getTime();
                    }
                    return itemDate >= weekAgoTimestamp;
                }).length;
                
                // Update UI
                updateStatCard('stat-products', totalProducts, newProductsThisWeek > 0 ? `+${newProductsThisWeek} Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹` : 'Ù„Ø§ ØªØºÙŠÙŠØ±');
                updateStatCard('stat-orders', todayOrdersCount, ordersChange != 0 ? `${ordersChange > 0 ? '+' : ''}${ordersChange}% Ù…Ù† Ø£Ù…Ø³` : 'Ù„Ø§ ØªØºÙŠÙŠØ±');
                updateStatCard('stat-revenue', todayRevenue.toFixed(3), revenueChange != 0 ? `${revenueChange > 0 ? '+' : ''}${revenueChange}% Ù…Ù† Ø£Ù…Ø³` : 'Ù„Ø§ ØªØºÙŠÙŠØ±');
                updateStatCard('stat-customers', todayCustomersCount, newCustomers > 0 ? `+${newCustomers} Ø¬Ø¯ÙŠØ¯` : newCustomers < 0 ? `${newCustomers} Ø£Ù‚Ù„` : 'Ù„Ø§ ØªØºÙŠÙŠØ±');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            }
        }
        
        function updateStatCard(elementId, value, changeText) {
            const element = document.getElementById(elementId);
            if (element) {
                // Format number with commas
                const formattedValue = typeof value === 'number' ? 
                    value.toLocaleString('ar-SA') : value;
                element.textContent = formattedValue;
                
                // Update change text
                const changeElement = element.parentElement.querySelector('.stat-change span');
                if (changeElement) {
                    changeElement.textContent = changeText;
                    const changeContainer = element.parentElement.querySelector('.stat-change');
                    if (changeContainer) {
                        changeContainer.classList.remove('up', 'down');
                        if (changeText.includes('+') || changeText.includes('Ø¬Ø¯ÙŠØ¯')) {
                            changeContainer.classList.add('up');
                        } else if (changeText.includes('-') || changeText.includes('Ø£Ù‚Ù„')) {
                            changeContainer.classList.add('down');
                        } else {
                            changeContainer.style.opacity = '0.6';
                        }
                    }
                }
            }
        }
        
        // Load recent orders (uses the already loaded orders array)
        function loadRecentOrders() {
            const tbody = document.getElementById('recent-orders');
            if (!tbody) return;
            
            const allOrders = orders.slice(0, 10); // Last 10 orders
            
            if (allOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                return;
            }
            
            tbody.innerHTML = allOrders.map(order => {
                    const orderId = order.id || 'N/A';
                    const customerName = order.customerName || order.tableNumber || 'Ø¨Ø¯ÙˆÙ† Ø·Ø§ÙˆÙ„Ø©';
                    const workerName = order.workerName || order.createdBy || order.cashierName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const items = order.items || [];
                    const itemsText = items.length > 0 ? 
                        items.slice(0, 2).map(item => `${item.quantity || 1}x ${item.name || 'Ù…Ù†ØªØ¬'}`).join('ØŒ ') + 
                        (items.length > 2 ? ` +${items.length - 2} Ø£ÙƒØ«Ø±` : '') : 
                        'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª';
                    const total = parseFloat(order.total || order.amount || 0).toFixed(3);
                    const status = order.status || 'pending';
                    const statusClass = {
                        'completed': 'badge-success',
                        'paid': 'badge-success',
                        'delivered': 'badge-success',
                        'preparing': 'badge-warning',
                        'pending': 'badge-primary',
                        'cancelled': 'badge-danger'
                    }[status] || 'badge-primary';
                    const statusText = {
                        'completed': 'Ù…ÙƒØªÙ…Ù„',
                        'paid': 'Ù…Ø¯ÙÙˆØ¹',
                        'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                        'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
                        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                        'cancelled': 'Ù…Ù„ØºÙŠ'
                    }[status] || status;
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ timestamp Ø±Ù‚Ù…ÙŠ
                    const orderDate = order.createdAt || order.timestamp || order.date || null;
                    const timeDisplay = formatOrderTime(orderDate);
                    
                    return `
                        <tr>
                            <td>#${String(orderId).slice(-6)}</td>
                            <td>${customerName}</td>
                            <td><span style="color: var(--primary); font-weight: 600;"><i class="fas fa-user-tie" style="margin-left: 5px;"></i>${workerName}</span></td>
                            <td>${itemsText}</td>
                            <td>${total} Ø±.Ø¹</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>${timeDisplay}</td>
                        </tr>
                    `;
                }).join('');
        }
        
        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ timestamp Ø±Ù‚Ù…ÙŠ
        function parseOrderDate(dateValue) {
            if (!dateValue) return null;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… (timestamp)
            if (typeof dateValue === 'number') {
                return dateValue;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Øµ (ISO string Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø±)
            if (typeof dateValue === 'string') {
                const parsed = new Date(dateValue);
                if (!isNaN(parsed.getTime())) {
                    return parsed.getTime();
                }
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒØ§Ø¦Ù† Date
            if (dateValue instanceof Date) {
                return dateValue.getTime();
            }
            
            return null;
        }
        
        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø´ÙƒÙ„ Ù…ÙÙ‡ÙˆÙ…
        function formatOrderTime(dateValue) {
            const timestamp = parseOrderDate(dateValue);
            
            if (!timestamp) {
                return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
            
            const orderDate = new Date(timestamp);
            const now = new Date();
            const diff = now.getTime() - timestamp;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø³Ø§Ù„Ø¨ (ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) Ø£Ùˆ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹
            if (diff < 0 || diff > 365 * 24 * 60 * 60 * 1000) {
                return orderDate.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
            if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
            
            // Ø£ÙƒØ«Ø± Ù…Ù† Ø£Ø³Ø¨ÙˆØ¹ - Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙƒØ§Ù…Ù„
            return orderDate.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getTimeAgo(timestamp) {
            return formatOrderTime(timestamp);
        }
    </script>
    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        (async () => {
            try {
                if (typeof AuthCheck !== 'undefined') {
                    const isAuthenticated = await AuthCheck.requireAuth('admin', 'login-admin.html');
                    if (!isAuthenticated) return;
                } else {
                    // Fallback Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    const authCheck = sessionStorage.getItem('auth_user_type') === 'admin';
                    if (!authCheck) {
                        window.location.href = 'login-admin.html';
                        return;
                    }
                }
            } catch (error) {
                if (typeof ErrorHandler !== 'undefined') {
                    ErrorHandler.handleError(error, 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error');
                }
                window.location.href = 'login-admin.html';
            }
        })();

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function displayUserInfo() {
            let userName = 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
            let userRole = 'Ø£Ø¯Ù…Ù†';
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (typeof AuthCheck !== 'undefined' && AuthCheck.getCurrentUserData) {
                const userData = AuthCheck.getCurrentUserData();
                if (userData) {
                    userName = userData.name || 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
                    userRole = userData.role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : (userData.role === 'worker' ? 'Ø¹Ø§Ù…Ù„' : 'Ù…Ø¯ÙŠØ±');
                }
            } else {
                // Fallback
                const userDataStr = sessionStorage.getItem('auth_user_data');
                if (userDataStr) {
                    try {
                        const userData = JSON.parse(userDataStr);
                        userName = userData.name || 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
                        userRole = userData.role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : (userData.role === 'worker' ? 'Ø¹Ø§Ù…Ù„' : 'Ù…Ø¯ÙŠØ±');
                    } catch (e) {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    }
                }
            }
            
            const userNameDisplay = document.getElementById('user-name-display');
            const userRoleDisplay = document.getElementById('user-role-display');
            
            if (userNameDisplay && userRoleDisplay) {
                userNameDisplay.textContent = userName;
                userRoleDisplay.textContent = userRole;
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        async function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                try {
                    if (typeof AuthCheck !== 'undefined' && AuthCheck.logout) {
                        await AuthCheck.logout();
                    } else {
                        // Fallback
                        sessionStorage.clear();
                        window.location.href = 'login-admin.html';
                    }
                } catch (error) {
                    if (typeof ErrorHandler !== 'undefined') {
                        ErrorHandler.handleError(error, 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
                    }
                    sessionStorage.clear();
                    window.location.href = 'login-admin.html';
                }
            }
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        displayUserInfo();

        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù…Ù† Console)
        window.initializeDatabase = async function() {
            try {
                const RESTAURANT_ID = 'mirmaia-1';
                const db = firebase.database();
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…
                await db.ref(`restaurant-system/restaurants/${RESTAURANT_ID}`).set({
                    name: 'Mirmaia',
                    type: 'cafe',
                    username: 'admin',
                    password: 'admin123',
                    status: 'active',
                    phone: '99123456',
                    address: 'Mirmaia',
                    createdAt: new Date().toISOString()
                });
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
                await db.ref(`restaurant-system/superAdmins/admin-1`).set({
                    username: 'admin',
                    password: 'admin123',
                    name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
                    createdAt: new Date().toISOString()
                });
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
                await db.ref(`restaurant-system/sites/mirmaia`).set({
                    name: 'Mirmaia',
                    type: 'restaurant',
                    url: 'https://mirmaia-33acc.web.app',
                    restaurantId: RESTAURANT_ID,
                    status: 'active',
                    createdAt: new Date().toISOString()
                });
                
                // ØªØµÙ†ÙŠÙØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const categories = [
                    { id: 'shisha', name: 'Ø§Ù„Ø´ÙŠØ´Ø©', order: 1, icon: 'ğŸ’¨' },
                    { id: 'hot-drinks', name: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø®Ù†Ø©', order: 2, icon: 'â˜•' },
                    { id: 'cold-drinks', name: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø¨Ø§Ø±Ø¯Ø©', order: 3, icon: 'ğŸ§Š' },
                    { id: 'desserts', name: 'Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª', order: 4, icon: 'ğŸ°' },
                    { id: 'snacks', name: 'Ø§Ù„Ù…Ù‚Ø¨Ù„Ø§Øª', order: 5, icon: 'ğŸ¥¨' }
                ];
                
                for (const category of categories) {
                    await db.ref(`restaurant-system/categories/${RESTAURANT_ID}/${category.id}`).set({
                        name: category.name,
                        order: category.order,
                        icon: category.icon,
                        active: true,
                        createdAt: new Date().toISOString()
                    });
                }
                
                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                alert('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                window.location.reload();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        };
        
        // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
        document.addEventListener('DOMContentLoaded', function() {
            const initBtn = document.getElementById('init-sample-data-btn');
            if (initBtn) {
                const isAdmin = localStorage.getItem('admin_logged_in') === 'true';
                if (!isAdmin) {
                    initBtn.style.display = 'none';
                } else {
                    initBtn.onclick = function() {
                        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù„Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø´Ø§Ù…Ù„Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ©:\nâœ… 6 ØªØµÙ†ÙŠÙØ§Øª\nâœ… Ø£ÙƒØ«Ø± Ù…Ù† 40 Ù…Ù†ØªØ¬\nâœ… 4 Ø¹Ù…Ø§Ù„\nâœ… 6 ØºØ±Ù\nâœ… 3 Ø·Ù„Ø¨Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©\nâœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù… ÙˆØ§Ù„Ù…Ø¯ÙŠØ±\n\nâš ï¸ Ù‚Ø¯ ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©!')) {
                            if (typeof initializeSampleData === 'function') {
                                initializeSampleData();
                            } else {
                                alert('Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù init-sample-data.js');
                            }
                        }
                    };
                }
            }
        });
    </script>
</body>
</html>
