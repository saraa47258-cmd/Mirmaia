# Automatic Daily Firebase Backup
# النسخ الاحتياطي التلقائي اليومي

name: Daily Firebase Backup

on:
  # Run every day at 11:00 PM (UTC) = 3:00 AM Oman Time
  schedule:
    - cron: '0 23 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Required permissions for pushing to repository
permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Backup Firebase Data
        run: |
          # Set variables
          DATABASE_URL="https://sham-coffee-default-rtdb.firebaseio.com"
          RESTAURANT_ID="sham-coffee-1"
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          BACKUP_DIR="firebase-backups/${TIMESTAMP}"
          
          mkdir -p "$BACKUP_DIR"
          
          echo "========================================"
          echo "  Firebase Backup - Sham Coffee"
          echo "========================================"
          echo ""
          echo "Backup started at: $(date)"
          echo "Backup folder: $BACKUP_DIR"
          echo ""
          
          # Collections to backup
          COLLECTIONS="orders menu categories workers tables rooms daily_closings invoices"
          
          for collection in $COLLECTIONS; do
            echo "Backing up $collection..."
            curl -s "${DATABASE_URL}/restaurant-system/${collection}/${RESTAURANT_ID}.json" -o "${BACKUP_DIR}/${collection}.json"
            
            # Check if file has content
            if [ -s "${BACKUP_DIR}/${collection}.json" ]; then
              SIZE=$(wc -c < "${BACKUP_DIR}/${collection}.json")
              echo "  Done - ${SIZE} bytes"
            else
              echo "  Empty or not found"
            fi
          done
          
          # Create summary
          cat > "${BACKUP_DIR}/_summary.json" << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "restaurant_id": "${RESTAURANT_ID}",
            "backup_date": "$(date +%Y-%m-%d)",
            "backup_time": "$(date +%H:%M:%S)"
          }
          EOF
          
          echo ""
          echo "Backup completed!"
          echo ""
          echo "Files created:"
          ls -la "$BACKUP_DIR"
      
      - name: Keep only last 30 backups
        run: |
          cd firebase-backups
          # Count folders and remove oldest if more than 30
          BACKUP_COUNT=$(ls -d */ 2>/dev/null | wc -l || echo "0")
          echo "Current backup count: $BACKUP_COUNT"
          if [ "$BACKUP_COUNT" -gt 30 ]; then
            echo "Cleaning old backups (keeping last 30)..."
            ls -dt */ | tail -n +31 | xargs rm -rf
          fi
      
      - name: Commit and Push Backup
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          git add firebase-backups/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Backup $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "Backup pushed to GitHub!"
          fi
