<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ù‡ÙˆØ© Ø§Ù„Ø´Ø§Ù… | Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Reports Page Styles */
        .page-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -20%;
            width: 60%;
            height: 200%;
            background: rgba(255,255,255,0.05);
            transform: rotate(30deg);
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Date Filter */
        .filter-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-btn {
            padding: 12px 25px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text);
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--gradient);
            border-color: var(--primary);
            color: white;
        }

        .date-input {
            padding: 12px 18px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 12px;
            font-family: inherit;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.1;
            transform: translate(30%, -30%);
        }

        .stat-card.revenue::before { background: #10b981; }
        .stat-card.orders::before { background: #3b82f6; }
        .stat-card.products::before { background: #f59e0b; }
        .stat-card.customers::before { background: #8b5cf6; }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .stat-card.revenue .stat-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .stat-card.orders .stat-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .stat-card.products .stat-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .stat-card.customers .stat-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .stat-change.up {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .stat-change.down {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--gold);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Products Table */
        .table-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-title i {
            color: var(--gold);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg);
            padding: 10px 18px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .search-box input {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            width: 200px;
        }

        .search-box input:focus {
            outline: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: right;
        }

        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .data-table tr {
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .data-table tbody tr:hover {
            background: var(--card-hover);
        }

        .product-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .product-emoji {
            width: 45px;
            height: 45px;
            background: var(--bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .product-info h4 {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .product-info span {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge.high { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .badge.medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .badge.low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Export Buttons */
        .export-btns {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .export-btn.pdf {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .export-btn.excel {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .export-btn.print {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Top Products */
        .top-products-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .top-product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
        }

        .top-product-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
        }

        .top-product-rank.gold { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .top-product-rank.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); color: white; }
        .top-product-rank.bronze { background: linear-gradient(135deg, #b45309, #92400e); color: white; }
        .top-product-rank.normal { background: var(--card-bg); color: var(--text-secondary); }

        .top-product-info {
            flex: 1;
        }

        .top-product-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .top-product-qty {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .top-product-revenue {
            font-weight: 700;
            color: var(--gold);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
        }

        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            animation: toastIn 0.4s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .toast.success { border-right: 4px solid var(--success); }
        .toast.error { border-right: 4px solid var(--danger); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
            <p>ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</p>
        </div>

        <!-- Date Filter -->
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label"><i class="fas fa-calendar"></i> Ø§Ù„ÙØªØ±Ø©:</span>
                <button class="filter-btn active" onclick="setDateRange('today')">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="filter-btn" onclick="setDateRange('week')">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="filter-btn" onclick="setDateRange('month')">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
                <button class="filter-btn" onclick="setDateRange('year')">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Ù…Ù†:</span>
                <input type="date" class="date-input" id="date-from" onchange="loadReports()">
                <span class="filter-label">Ø¥Ù„Ù‰:</span>
                <input type="date" class="date-input" id="date-to" onchange="loadReports()">
            </div>
            <button class="btn btn-primary" onclick="loadReports()">
                <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card revenue">
                <div class="stat-icon"><i class="fas fa-coins"></i></div>
                <div class="stat-value" id="total-revenue">0.000</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±.Ø¹)</div>
                <div class="stat-change up" id="revenue-change">
                    <i class="fas fa-arrow-up"></i>
                    <span>0%</span>
                </div>
            </div>
            <div class="stat-card orders">
                <div class="stat-icon"><i class="fas fa-receipt"></i></div>
                <div class="stat-value" id="total-orders">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                <div class="stat-change up" id="orders-change">
                    <i class="fas fa-arrow-up"></i>
                    <span>0%</span>
                </div>
            </div>
            <div class="stat-card products">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</div>
                <div class="stat-change up" id="products-change">
                    <i class="fas fa-arrow-up"></i>
                    <span>0%</span>
                </div>
            </div>
            <div class="stat-card customers">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value" id="avg-order">0.000</div>
                <div class="stat-label">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø±.Ø¹)</div>
                <div class="stat-change up" id="avg-change">
                    <i class="fas fa-arrow-up"></i>
                    <span>0%</span>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <!-- Revenue Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> ØªØ·ÙˆØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenue-chart"></canvas>
                </div>
            </div>

            <!-- Orders Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                </div>
                <div class="chart-container">
                    <canvas id="orders-chart"></canvas>
                </div>
            </div>

            <!-- Categories Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                </div>
                <div class="chart-container">
                    <canvas id="categories-chart"></canvas>
                </div>
            </div>

            <!-- Top Products -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-trophy"></i> Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                </div>
                <div class="top-products-list" id="top-products-list">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="table-section">
            <div class="table-header">
                <h3 class="table-title"><i class="fas fa-list"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</h3>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="search-box">
                        <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                        <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." id="product-search" oninput="filterProducts()">
                    </div>
                    <div class="export-btns">
                        <button class="export-btn print" onclick="printReport()">
                            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button class="export-btn excel" onclick="exportExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
            </div>
            <table class="data-table" id="products-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="products-tbody">
                    <!-- Filled dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Payment Methods -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-credit-card"></i> Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
                </div>
                <div class="chart-container">
                    <canvas id="payment-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title"><i class="fas fa-clock"></i> Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©</h3>
                </div>
                <div class="chart-container">
                    <canvas id="hours-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBD3RarLj_696emYW84zZ1tliP_Th1z6mM",
            authDomain: "sham-coffee.firebaseapp.com",
            databaseURL: "https://sham-coffee-default-rtdb.firebaseio.com",
            projectId: "sham-coffee",
            storageBucket: "sham-coffee.firebasestorage.app",
            messagingSenderId: "483086837036",
            appId: "1:483086837036:web:2a6bf9084050ef399ef889"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    <script src="js/common.js"></script>
    <script src="js/sidebar.js"></script>
    <script>
        // Firebase paths
        function getRestaurantId() {
            return localStorage.getItem('restaurant_id') || 'sham-coffee-1';
        }
        const RESTAURANT_ID = getRestaurantId();
        const ORDERS_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/orders`;
        const MENU_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/menu`;
        const CATEGORIES_PATH = `restaurant-system/restaurants/${RESTAURANT_ID}/categories`;

        // Data
        let allOrders = [];
        let filteredOrders = [];
        let menuItems = {};
        let categories = {};
        let productStats = [];

        // Charts
        let revenueChart, ordersChart, categoriesChart, paymentChart, hoursChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            loadData();
        });

        function setDefaultDates() {
            const today = new Date();
            const startOfDay = new Date(today);
            startOfDay.setHours(0, 0, 0, 0);
            
            document.getElementById('date-from').value = today.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
        }

        function setDateRange(range) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const today = new Date();
            let fromDate = new Date();
            
            switch(range) {
                case 'today':
                    fromDate = new Date(today);
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate.setMonth(today.getMonth() - 1);
                    break;
                case 'year':
                    fromDate.setFullYear(today.getFullYear() - 1);
                    break;
            }

            document.getElementById('date-from').value = fromDate.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
            
            loadReports();
        }

        async function loadData() {
            try {
                // Load menu items
                const menuSnapshot = await firebase.database().ref(MENU_PATH).once('value');
                if (menuSnapshot.exists()) {
                    menuSnapshot.forEach(child => {
                        menuItems[child.key] = child.val();
                    });
                }

                // Load categories
                const catSnapshot = await firebase.database().ref(CATEGORIES_PATH).once('value');
                if (catSnapshot.exists()) {
                    catSnapshot.forEach(child => {
                        categories[child.key] = child.val();
                    });
                }

                // Load orders
                const ordersSnapshot = await firebase.database().ref(ORDERS_PATH).once('value');
                allOrders = [];
                if (ordersSnapshot.exists()) {
                    ordersSnapshot.forEach(child => {
                        allOrders.push({ id: child.key, ...child.val() });
                    });
                }

                loadReports();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        function loadReports() {
            const fromDate = new Date(document.getElementById('date-from').value);
            fromDate.setHours(0, 0, 0, 0);
            
            const toDate = new Date(document.getElementById('date-to').value);
            toDate.setHours(23, 59, 59, 999);

            // Filter orders by date
            filteredOrders = allOrders.filter(order => {
                const orderDate = new Date(order.createdAt || order.timestamp);
                return orderDate >= fromDate && orderDate <= toDate;
            });

            // Calculate statistics
            calculateStats();
            
            // Update charts
            updateCharts(fromDate, toDate);
            
            // Update products table
            updateProductsTable();
        }

        function calculateStats() {
            // Total revenue (only paid orders)
            const paidOrders = filteredOrders.filter(o => o.status === 'paid' || o.status === 'completed');
            const totalRevenue = paidOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
            
            // Total orders
            const totalOrders = filteredOrders.length;
            
            // Total products sold
            let totalProducts = 0;
            filteredOrders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        totalProducts += parseInt(item.quantity || 1);
                    });
                }
            });
            
            // Average order value
            const avgOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            // Update UI
            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(3);
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('avg-order').textContent = avgOrder.toFixed(3);

            // Calculate product stats
            calculateProductStats();
        }

        function calculateProductStats() {
            const stats = {};
            
            filteredOrders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        const key = item.name || item.id;
                        if (!stats[key]) {
                            stats[key] = {
                                name: item.name,
                                emoji: item.emoji || 'ğŸ“¦',
                                category: item.category || 'ØºÙŠØ± Ù…ØµÙ†Ù',
                                quantity: 0,
                                revenue: 0,
                                unitPrice: parseFloat(item.price || 0)
                            };
                        }
                        stats[key].quantity += parseInt(item.quantity || 1);
                        stats[key].revenue += parseFloat(item.price || 0) * parseInt(item.quantity || 1);
                    });
                }
            });

            productStats = Object.values(stats).sort((a, b) => b.revenue - a.revenue);
        }

        function updateCharts(fromDate, toDate) {
            const daysDiff = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Prepare daily data
            const dailyData = {};
            const categoryData = {};
            const paymentData = { cash: 0, card: 0, other: 0 };
            const hourlyData = Array(24).fill(0);

            for (let i = 0; i < daysDiff; i++) {
                const date = new Date(fromDate);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                dailyData[dateStr] = { revenue: 0, orders: 0 };
            }

            filteredOrders.forEach(order => {
                const orderDate = new Date(order.createdAt || order.timestamp);
                const dateStr = orderDate.toISOString().split('T')[0];
                const hour = orderDate.getHours();
                
                if (dailyData[dateStr]) {
                    dailyData[dateStr].orders++;
                    if (order.status === 'paid' || order.status === 'completed') {
                        dailyData[dateStr].revenue += parseFloat(order.total || 0);
                    }
                }

                // Payment methods
                if (order.paymentMethod === 'cash' || order.paymentMethod === 'Ù†Ù‚Ø¯Ø§Ù‹') {
                    paymentData.cash += parseFloat(order.total || 0);
                } else if (order.paymentMethod === 'card' || order.paymentMethod === 'Ø¨Ø·Ø§Ù‚Ø©') {
                    paymentData.card += parseFloat(order.total || 0);
                } else {
                    paymentData.other += parseFloat(order.total || 0);
                }

                // Hourly distribution
                hourlyData[hour]++;

                // Categories
                if (order.items) {
                    order.items.forEach(item => {
                        const cat = item.category || 'Ø£Ø®Ø±Ù‰';
                        if (!categoryData[cat]) categoryData[cat] = 0;
                        categoryData[cat] += parseFloat(item.price || 0) * parseInt(item.quantity || 1);
                    });
                }
            });

            // Revenue Chart
            updateRevenueChart(dailyData);
            
            // Orders Chart
            updateOrdersChart(dailyData);
            
            // Categories Chart
            updateCategoriesChart(categoryData);
            
            // Payment Chart
            updatePaymentChart(paymentData);
            
            // Hours Chart
            updateHoursChart(hourlyData);
            
            // Top Products
            updateTopProducts();
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            const labels = Object.keys(data).map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
            });
            const values = Object.values(data).map(d => d.revenue);

            if (revenueChart) revenueChart.destroy();
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±.Ø¹)',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        function updateOrdersChart(data) {
            const ctx = document.getElementById('orders-chart').getContext('2d');
            const labels = Object.keys(data).map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
            });
            const values = Object.values(data).map(d => d.orders);

            if (ordersChart) ordersChart.destroy();
            
            ordersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                        data: values,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af', stepSize: 1 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        function updateCategoriesChart(data) {
            const ctx = document.getElementById('categories-chart').getContext('2d');
            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ef4444', '#ec4899', '#6366f1', '#14b8a6'];

            if (categoriesChart) categoriesChart.destroy();
            
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af', padding: 15 }
                        }
                    }
                }
            });
        }

        function updatePaymentChart(data) {
            const ctx = document.getElementById('payment-chart').getContext('2d');

            if (paymentChart) paymentChart.destroy();
            
            paymentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ù†Ù‚Ø¯Ø§Ù‹', 'Ø¨Ø·Ø§Ù‚Ø©', 'Ø£Ø®Ø±Ù‰'],
                    datasets: [{
                        data: [data.cash, data.card, data.other],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af', padding: 15 }
                        }
                    }
                }
            });
        }

        function updateHoursChart(data) {
            const ctx = document.getElementById('hours-chart').getContext('2d');
            const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);

            if (hoursChart) hoursChart.destroy();
            
            hoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                        data: data,
                        backgroundColor: data.map((v, i) => {
                            const max = Math.max(...data);
                            const intensity = max > 0 ? v / max : 0;
                            return `rgba(139, 92, 246, ${0.3 + intensity * 0.7})`;
                        }),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af', stepSize: 1 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af', maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function updateTopProducts() {
            const container = document.getElementById('top-products-list');
            const top5 = productStats.slice(0, 5);

            if (top5.length === 0) {
                container.innerHTML = '<div class="loading"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>';
                return;
            }

            container.innerHTML = top5.map((product, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'normal';
                return `
                    <div class="top-product-item">
                        <div class="top-product-rank ${rankClass}">${i + 1}</div>
                        <span style="font-size: 1.5rem;">${product.emoji}</span>
                        <div class="top-product-info">
                            <div class="top-product-name">${product.name}</div>
                            <div class="top-product-qty">${product.quantity} ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø¹Ø©</div>
                        </div>
                        <div class="top-product-revenue">${product.revenue.toFixed(3)} Ø±.Ø¹</div>
                    </div>
                `;
            }).join('');
        }

        function updateProductsTable() {
            const tbody = document.getElementById('products-tbody');
            const totalRevenue = productStats.reduce((sum, p) => sum + p.revenue, 0);

            if (productStats.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = productStats.map((product, i) => {
                const percentage = totalRevenue > 0 ? (product.revenue / totalRevenue * 100) : 0;
                const badgeClass = percentage >= 20 ? 'high' : percentage >= 10 ? 'medium' : 'low';
                
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>
                            <div class="product-cell">
                                <div class="product-emoji">${product.emoji}</div>
                                <div class="product-info">
                                    <h4>${product.name}</h4>
                                </div>
                            </div>
                        </td>
                        <td>${product.category}</td>
                        <td><strong>${product.quantity}</strong></td>
                        <td>${product.unitPrice.toFixed(3)} Ø±.Ø¹</td>
                        <td><strong style="color: var(--gold);">${product.revenue.toFixed(3)} Ø±.Ø¹</strong></td>
                        <td><span class="badge ${badgeClass}">${percentage.toFixed(1)}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        function filterProducts() {
            const search = document.getElementById('product-search').value.toLowerCase();
            const rows = document.querySelectorAll('#products-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function printReport() {
            window.print();
        }

        function exportExcel() {
            // Create CSV content
            let csv = 'Ø§Ù„Ù…Ù†ØªØ¬,Ø§Ù„ÙØ¦Ø©,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\n';
            productStats.forEach(p => {
                csv += `${p.name},${p.category},${p.quantity},${p.unitPrice.toFixed(3)},${p.revenue.toFixed(3)}\n`;
            });

            // Download
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
        const isAdmin = localStorage.getItem('admin_logged_in') === 'true';
        const isWorker = localStorage.getItem('worker_logged_in') === 'true';
        
        if (!isAdmin && !isWorker) {
            window.location.href = 'login-admin.html';
        }
    </script>
</body>
</html>

